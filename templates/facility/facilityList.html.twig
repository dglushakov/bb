{% extends 'home.html.twig' %}

{% block javascriptsBeforeBody %}
    {{ parent() }}

    <script type='text/javascript'
            src='http://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AtrbFcv5kIq0_lr7oP2X9gCjolUGnrCC7zmicDR8cDymFpqV5Pm0JvGU0joAa3I3'
            async defer></script>

{% endblock %}
{% block main %}
    <div class="row m-2">
        <div class="col">
            <div id='myMap' style='width: 100%; height: 600px;'></div>
        </div>
    </div>
    {% if is_granted('ROLE_NVR_ADD') %}
        <div class="row bg-light p-2">
            <div class="col">
                {% form_theme form 'bootstrap_4_layout.html.twig' %}
                {{ form_start(form) }}
                {{ form_errors(form) }}
                <div class="row">
                    <div class="col">
                        {{ form_row(form.Name) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.PostCode) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.Country) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.Region) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.City) }}
                    </div>
                    <div class="col"></div>

                </div>
                <div class="row">

                    <div class="col">
                        {{ form_row(form.StreetType) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.Street) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.House) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.BuildingType) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.Building) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.Room) }}
                    </div>

                </div>
                <div class="row">
                    <div class="col">
                        {{ form_row(form.Submit, { 'label': 'Add new' }) }}
                    </div>
                    <div class="col"></div>
                    <div class="col"></div>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    {% endif %}
    <div class="row">
        <div class="col">

            <table class="table table-striped table-bordered mt-4">
                <thead>
                <tr class="">
                    <th class="tr_fixed">
                        #
                    </th>
                    <th class="tr_fixed">
                        Name
                    </th>
                    <th class="tr_fixed">
                        Address
                    </th>
                    <th class="tr_fixed">
                        Actions
                    </th>
                </tr>
                </thead>
                <tbody class="pt-5">
                {% for facility in facilities %}
                    <tr>
                        <td>
                            <a href="{{ path('facilityPassport', {id: facility.id}) }}">
                                {{ loop.index }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ path('facilityPassport', {id: facility.id}) }}">
                                {{ facility.name }}
                            </a>
                        </td>
                        <td>{{ facility.address }}</td>
                        <td>
                            <a href="/facility/edit/{{ facility.id }}" class="btn btn-sm"><img
                                        alt="edit"
                                        width="20px"
                                        src="{{ asset('img/edit.png') }}">
                            </a>

                            {% if nvrCount[facility.id]==0 %}
                                <a href="#" data-href="/facility/delete/{{ facility.id }}" data-toggle="modal"
                                   data-target="#confirm-delete" class="btn btn-sm delete-type">
                                    <img alt="delete" width="20px" src="{{ asset('img/cancel.png') }}">
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                {% include 'include/deleteConfirmationModal.html.twig' %}
                </tbody>
            </table>
        </div>
    </div>


{% endblock %}


{% block javascriptsAfterBody %}
    {{ parent() }}

    <script>
        $('#confirm-delete').on('show.bs.modal', function (e) {
            $(this).find('.btn-ok').attr('href', $(e.relatedTarget).data('href'));
        });

        $('#add_facility_form_Region').prop("readonly", true);

        $('#add_facility_form_Country').on('change', function (data) {
            var optionSelected = $(this).find("option:selected");
            var textSelected = optionSelected.text();

            var path = '{{ path('getCities') }}';
            path = path + '/' + textSelected;
            $.ajax({
                method: "POST",
                url: path,

            }).done(function (data) {
                $('#add_facility_form_City').empty();
                $.each(data, function (val, text) {
                    $('#add_facility_form_City').append(
                        $('<option></option>').val(text['city']).html(text['city'] + ' регион: ' + text['region'])
                    );
                });
            })
        });

        $('#add_facility_form_City').on('change', function (data) {
            var region = $(this).children("option:selected").val();
            region = $(this).children("option:selected").html();

            var regionStartPostition = region.indexOf('регион') + 8;
            var regionToOutput = region.slice(regionStartPostition);

            $("#add_facility_form_Region").val(regionToOutput);
        });


    </script>

    <script>
        $(document).ready(function () {
            var addresses = [];
            var coordinates = [];
            {% for facility in facilities %}
            {% set i = loop.index-1 %}
            addresses[{{ i }}] = [];
            addresses[{{ i }}]['city'] = '{{ facility.city }}';
            addresses[{{ i }}]['street'] = '{{ facility.street }}';
            addresses[{{ i }}]['house'] = '{{ facility.house }}';
            {% endfor %}

            function getCoordinatesByAdress($city, $street, $house, $id) {
                var url;
                url = 'https://nominatim.openstreetmap.org/search?city=' + $city + '&street=' + $street + ' ' + $house + '&format=json&limit=1';
                coordinates[$id] = [];
                coordinates[$id]['address'] = $city + ' ' + $street + ' ' + $house;
                $.ajax({
                    url: url,
                    success: function (data) {
                        if (data.length !== 0) {
                            coordinates[$id]['lat'] = data[0]['lat'];
                            coordinates[$id]['lon'] = data[0]['lon'];
                        } else {
                            coordinates[$id]['lat'] = 'invalid address';
                            coordinates[$id]['lon'] = 'invalid address';
                        }
                        if ($id === addresses.length - 1) {
                            setTimeout(GetMap, 2000);
                        }
                    }
                });
            }

            for (let i = 0; i < addresses.length; i++) {
                getCoordinatesByAdress(addresses[i]['city'], addresses[i]['street'], addresses[i]['house'], i);
            }


            var map, clusterLayer;

            function GetMap() {
                map = new Microsoft.Maps.Map('#myMap', {
                    zoom: 3,
                });
                Microsoft.Maps.loadModule("Microsoft.Maps.Clustering", function () {
                    var pins = [];
                    for (var i = 0; i < coordinates.length; i++) {
                        if (coordinates[i]['lat'] !== 'invalid address') {
                            var pin = new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(coordinates[i]['lat'], coordinates[i]['lon']));
                            //Store the original data object in the pushpins metadata so that you can access other properties like Name.
                            pin.metedata = coordinates[i];
                            pins.push(pin);
                        }
                    }

                    clusterLayer = new Microsoft.Maps.ClusterLayer(pins);
                    map.layers.insert(clusterLayer);
                });
            }
        });
    </script>

{% endblock %}